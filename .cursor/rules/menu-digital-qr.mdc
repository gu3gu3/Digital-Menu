---
description: 
globs: 
alwaysApply: true
---
# Principios y Reglas Fundamentales del Proyecto Digital Menu QR

## 1. La Infraestructura es Inmutable y Automatizada
El sistema de despliegue (Dockerfile, cloudbuild.yaml, start.sh) es estable y no debe tocarse a menos que sea estrictamente necesario y se haya probado.

**Regla 1.1: El Despliegue es Sagrado.** La √∫nica forma de actualizar producci√≥n es con git push a la rama main.

**Regla 1.2: El Dockerfile es el Plano.** Cualquier dependencia del sistema (como netcat-openbsd) debe estar en el Dockerfile.

**Regla 1.3: La Versi√≥n de Node.js es √önica.** La versi√≥n de Node.js debe ser la misma en el Dockerfile y en cloudbuild.yaml para evitar fallos de build.

## 2. El C√≥digo es Agn√≥stico al Entorno (Cero "Hardcoding")
El c√≥digo no debe contener valores fijos que cambien entre tu m√°quina y la nube.

**Regla 2.1: Toda Configuraci√≥n es Externa.** URLs, puertos y claves secretas se leen siempre desde variables de entorno.

**Regla 2.2: .env es para Desarrollo Local.** Contiene las variables para que todo funcione en tu computadora y est√° en .gitignore.

**Regla 2.3: Las Variables de Cloud Run son para Producci√≥n.** Son el panel de control para la nube. Las variables clave son:
- DATABASE_URL
- JWT_SECRET (el √∫nico secreto para todos los tokens)
- BACKEND_URL (la URL p√∫blica del backend, ej: https://...run.app)
- VITE_FRONTEND_URL (la URL p√∫blica del frontend, ej: https://menuview.app)
- EMAIL_USER, EMAIL_PASSWORD, EMAIL_HOST, EMAIL_PORT
- NODE_ENV
- GCP_STORAGE_BUCKET

## 3. Fronteras Claras entre Frontend y Backend
Cada parte tiene una √∫nica responsabilidad.

**Regla 3.1: El Backend Construye URLs de sus Recursos.** Para las im√°genes, el backend usa su BACKEND_URL para crear la ruta completa: `${process.env.BACKEND_URL}/uploads/imagen.jpg`.

**Regla 3.2: El Frontend Construye URLs de Navegaci√≥n.** Para compartir un men√∫, el frontend usa su VITE_FRONTEND_URL para crear el enlace: `${import.meta.env.VITE_FRONTEND_URL}/menu/nombre-restaurant`.

## 4. Configuraci√≥n Limpia y Consistente

**Regla 4.1: Eliminar Variables Obsoletas.** Si una variable en el archivo .env no se usa en el c√≥digo (como JWT_SECRET_SUPERADMIN), debe ser eliminada para evitar confusiones.

## 5. Diagn√≥stico Primero, Acci√≥n Despu√©s

**Regla 5.1: Los Logs son la Verdad.** Ante un error 500 en producci√≥n, el primer paso es siempre revisar los logs de Cloud Run. No se deben hacer cambios en el c√≥digo sin saber qu√© est√° fallando.

## 5.2 ‚≠ê **CORRECCIONES CR√çTICAS RECIENTES (Junio 23 2025)**

### Reglas de Manejo de Relaciones Prisma
**Regla 5.2.1: Include Statements Completos.** Los endpoints que acceden a propiedades de relaciones DEBEN incluir esas relaciones en el query Prisma. Error com√∫n: `suscripcion.restaurante.usuariosAdmin.length` sin `include: { restaurante: { include: { usuariosAdmin: true } } }`

**Regla 5.2.2: Validaci√≥n de Relaciones.** Antes de acceder a `objeto.relacion.propiedad`, verificar que la relaci√≥n est√© incluida en el query o manejar casos undefined.

### Reglas de B√∫squeda de Planes
**Regla 5.2.3: B√∫squeda Din√°mica de Planes.** NUNCA buscar planes por nombre hardcodeado. Usar criterios din√°micos como `precio: 0` para plan gratuito.

**Regla 5.2.4: Compatibilidad Producci√≥n.** El c√≥digo debe funcionar independientemente de los nombres exactos de datos en diferentes entornos.

### Reglas de Manejo de Tokens
**Regla 5.2.5: Invalidaci√≥n de Tokens.** Cuando se hacen cambios importantes en suscripciones/planes desde Super Admin, los tokens de administradores pueden invalidarse. Documentar este comportamiento.

**Regla 5.2.6: Experiencia de Usuario.** Proporcionar mensajes claros cuando se requiere renovar sesi√≥n tras cambios administrativos.

### Casos Espec√≠ficos Corregidos
- ‚úÖ **GET /api/super-admin/subscriptions/:id**: Agregadas relaciones `usuariosAdmin`, `productos`, `mesas`
- ‚úÖ **Registro de usuarios**: Cambiado de `nombre: 'Gratuito'` a `precio: 0, activo: true`
- ‚úÖ **Manejo de tokens**: Documentado comportamiento de invalidaci√≥n tras cambios

---

## 6. ‚≠ê ARQUITECTURA API CONSOLIDADA (Post-Refactorizaci√≥n 2025)

### Cliente API Unificado
**Regla 6.1: Un Solo Cliente API.** Todo el frontend debe usar `apiClient.js` (packages/frontend/src/lib/apiClient.js). NUNCA usar fetch directo o m√∫ltiples clientes.

**Regla 6.2: Interceptores Autom√°ticos.** El apiClient maneja autom√°ticamente tokens, errores y configuraci√≥n. No manejar tokens manualmente en componentes.

**Regla 6.3: Estructura de Respuesta Consistente.** Todas las APIs deben seguir el patr√≥n axios: `response.data` contiene la respuesta, `error.response.data.error` contiene errores.

### Gesti√≥n de Autenticaci√≥n
**Regla 6.4: TOKEN_MAPPING es la Verdad.** Los tipos de usuario y sus tokens est√°n definidos en authService.js:
```javascript
{
  'MESERO': { tokenKey: 'staffToken', userKey: 'staffUser' },
  'ADMINISTRADOR': { tokenKey: 'adminToken', userKey: 'adminUser' },
  'SUPER_ADMIN': { tokenKey: 'superAdminToken', userKey: 'superAdminUser' }
}
```

**Regla 6.5: Roles Backend vs Frontend.** El backend espera 'ADMINISTRADOR' y 'MESERO', no 'ADMIN' o 'STAFF'. Usar los valores exactos del TOKEN_MAPPING.

**Regla 6.6: Interceptores Buscan Tokens en Orden.** El apiClient busca autom√°ticamente: superAdminToken ‚Üí adminToken ‚Üí staffToken. No especificar tokens manualmente.

### Servicios Consolidados
**Regla 6.7: Un Servicio por Dominio.** Cada √°rea funcional tiene un servicio dedicado:
- authService.js: Autenticaci√≥n universal
- staffService.js: Gesti√≥n de personal  
- menuService.js: Gesti√≥n de men√∫
- restaurantService.js: Configuraci√≥n de restaurante
- superAdminService.js: Panel de super admin
- ordersService.js: Gesti√≥n de √≥rdenes
- notificationService.js: Sistema de notificaciones
- sessionsService.js: Sesiones de mesa

**Regla 6.8: Servicios Usan apiClient.** TODOS los servicios deben importar y usar apiClient, nunca fetch directo.

**Regla 6.9: Manejo de Errores Consistente.** Usar `error.response?.data?.error || 'Mensaje fallback'` para extraer errores de axios.

### Patrones de Importaci√≥n
**Regla 6.10: Importaciones Correctas.**
```javascript
// ‚úÖ CORRECTO
import apiClient from '../lib/apiClient'
import authService from '../services/authService'

// ‚ùå INCORRECTO
import { authService } from '../services/authService'
import adminApi from '../lib/adminApi'
```

**Regla 6.11: Rutas Relativas Consistentes.** Usar rutas sin `/api` en servicios: `apiClient.get('/categories')` no `apiClient.get('/api/categories')`.

## 7. Prevenci√≥n de Deriva de C√≥digo

**Regla 7.1: No M√∫ltiples Clientes API.** Si encuentras fetch directo, adminApi, o m√∫ltiples patrones de API, es deriva de c√≥digo. Consolidar inmediatamente.

**Regla 7.2: Testing Durante Refactor.** Validar que los 3 tipos de login funcionan despu√©s de cualquier cambio en autenticaci√≥n.

**Regla 7.3: Migraci√≥n Gradual.** Cambios arquitecturales deben hacerse por fases, validando cada fase antes de continuar.

**Regla 7.4: Documentar Cambios Arquitecturales.** Actualizar PROJECT-STATUS.md con cualquier refactorizaci√≥n significativa.

**Regla 7.5: Separaci√≥n P√∫blica vs Autenticada.** Los componentes p√∫blicos (OrderTracker, DemoSection) PUEDEN usar fetch directo porque no requieren autenticaci√≥n. Solo migrar componentes que manejan tokens.

**Regla 7.6: Validaci√≥n Continua Durante Migraci√≥n.** Despu√©s de cada cambio arquitectural, validar que los 3 tipos de login (Super Admin, Admin, Staff) siguen funcionando.

**Regla 7.7: Endpoint Consistency Check.** Antes de migrar, verificar que el endpoint existe en el backend. Usar `/me` en lugar de `/profile` para obtener datos del usuario actual.

**Regla 7.8: React Keys en Listas.** Todos los elementos mapeados deben tener keys √∫nicas. Usar `key={item.id || `fallback-${index}`}` para evitar warnings.

---

## An√°lisis Detallado de Rutas y L√≥gica Clave

### 1. Backend: Rutas de la API (packages/backend/src/routes/)

**Autenticaci√≥n:**
- `auth.js`: Login/registro de administradores de restaurantes (/api/auth/login)
- `superAdminAuth.js`: Login del superadministrador (/api/superadmin/auth/login)
- `staff.js`: Gesti√≥n del personal y autenticaci√≥n de meseros

**Gesti√≥n del Restaurante (Panel de Administrador):**
- `restaurants.js`: CRUD para informaci√≥n del restaurante
- `products.js`: CRUD para productos del men√∫
- `categories.js`: CRUD para categor√≠as del men√∫
- `tables.js`: CRUD para mesas y generaci√≥n de QR
- `orders.js`: Recepci√≥n y gesti√≥n de pedidos

**Gesti√≥n Global (Panel de Superadministrador):**
- `superAdminSubscriptions.js`: Manejo de suscripciones de restaurantes
- `admin.js`: Gesti√≥n de administradores de restaurantes

**Rutas P√∫blicas:**
- `public.js`: Endpoints p√∫blicos para visualizaci√≥n de men√∫
- `cart.js`: L√≥gica del carrito de compras para clientes

### 2. Frontend: Vistas y Flujo del Usuario (packages/frontend/src/pages/)

**Paneles de Control (Dashboards):**
- `AdminDashboard.jsx`: Panel principal del due√±o del restaurante
- `SuperAdminDashboard.jsx`: Panel principal del superadministrador
- `StaffDashboard.jsx`: Panel para personal del restaurante

**P√°ginas de Login (Puntos de Entrada):**
- `AdminLoginPage.jsx`: Login para administradores de restaurantes
- `SuperAdminLoginPage.jsx`: Login para superadministrador
- `StaffLoginPage.jsx`: Login para personal

**Gesti√≥n del Men√∫ (Administrador):**
- `AdminMenuPage.jsx`: Gesti√≥n completa de productos y categor√≠as
- `AdminSettingsPage.jsx`: Configuraci√≥n de perfil y restaurante

**Vista P√∫blica del Men√∫:**
- `PublicMenuPage.jsx`: Vista p√∫blica cuando se escanea QR

**Gesti√≥n de Superadministrador:**
- `SubscriptionsListPage.jsx`: Gesti√≥n de todas las suscripciones
- `PlansManagementPage.jsx`: Creaci√≥n y edici√≥n de planes de suscripci√≥n

### 3. Servicios Frontend Consolidados (packages/frontend/src/services/)

**Core Services:**
- `authService.js`: Autenticaci√≥n universal con TOKEN_MAPPING
- `apiClient.js`: Cliente HTTP unificado con interceptores autom√°ticos

**Domain Services:**
- `staffService.js`: Gesti√≥n de personal
- `menuService.js`: Operaciones de men√∫ (p√∫blico y autenticado)
- `restaurantService.js`: Configuraci√≥n de restaurante
- `superAdminService.js`: Operaciones de super admin
- `ordersService.js`: Gesti√≥n de √≥rdenes
- `notificationService.js`: Sistema de notificaciones
- `sessionsService.js`: Sesiones de mesa

**Regla de Oro:** Si necesitas comunicarte con el backend, usa un servicio existente o crea uno nuevo siguiendo los patrones consolidados. NUNCA uses fetch directo en componentes.

## 10. ‚≠ê MEJORAS DE UX Y COMPONENTES INTERACTIVOS (Junio 26 2025)

### Drag & Drop y Reordenamiento
**Regla 10.1: Drag & Drop con @dnd-kit.** Para funcionalidades de reordenamiento, usar @dnd-kit/core, @dnd-kit/sortable y @dnd-kit/utilities. Proporciona mejor accesibilidad y experiencia de usuario.

**Regla 10.2: Handles Visuales.** Incluir indicadores visuales claros (‚â°) para elementos arrastrables. Los usuarios deben saber intuitivamente qu√© pueden mover.

**Regla 10.3: Feedback Visual Durante Drag.** Implementar estados visuales durante el arrastre (opacidad, escalado, sombras) para confirmar la acci√≥n al usuario.

**Regla 10.4: Validaci√≥n de Permisos en Drag.** Solo permitir reordenar elementos que pertenecen al usuario/restaurante actual. Validar tanto en frontend como backend.

**Regla 10.5: Endpoints de Reordenamiento.** Crear endpoints espec√≠ficos para reordenamiento (ej: `/reorder`) que reciban arrays de objetos con id y nuevo orden. Usar transacciones para atomicidad.

### Optimizaci√≥n M√≥vil
**Regla 10.6: Pesta√±as Horizontales para M√≥viles.** En listas largas de categor√≠as, usar pesta√±as horizontales deslizables en lugar de sidebars verticales para mejor UX m√≥vil.

**Regla 10.7: Scroll Horizontal Suave.** Implementar scroll horizontal sin scrollbars visibles usando CSS (-webkit-scrollbar: none) y JavaScript para navegaci√≥n suave.

**Regla 10.8: Auto-scroll Inteligente.** Centrar autom√°ticamente el elemento seleccionado en vistas de scroll horizontal para mantener contexto visual.

**Regla 10.9: Indicadores de Contenido.** Mostrar contadores o indicadores de cantidad en pesta√±as/categor√≠as para dar contexto del contenido disponible.

**Regla 10.10: Efectos Visuales Sutiles.** Usar escalado (scale), sombras y transiciones suaves para feedback visual sin sobrecargar la interfaz.

### Patrones de Componentes
**Regla 10.11: Componentes Reutilizables de Drag & Drop.** Crear componentes base (DraggableList, DraggableItem) que puedan reutilizarse para diferentes tipos de contenido.

**Regla 10.12: Estados de Loading Durante Reordenamiento.** Mostrar indicadores de carga durante operaciones de reordenamiento para evitar m√∫ltiples acciones simult√°neas.

**Regla 10.13: Fallback para Errores de Reordenamiento.** Implementar rollback visual si la operaci√≥n de reordenamiento falla en el backend.

## 8. ‚≠ê PATRONES DE MIGRACI√ìN CONSOLIDADOS (Post-Fase 5)

### Identificaci√≥n de C√≥digo a Migrar
**Regla 8.1: Detectar Fetch Directo.** Buscar `fetch('/api/` en componentes autenticados. Los p√∫blicos son correctos.

**Regla 8.2: Detectar Tokens Manuales.** Buscar `localStorage.getItem('*Token')` en componentes - debe eliminarse.

**Regla 8.3: Detectar Headers Manuales.** Buscar `'Authorization': 'Bearer'` - los interceptores lo manejan autom√°ticamente.

### Patrones de Migraci√≥n
**Regla 8.4: Migraci√≥n de GET Simple.**
```javascript
// ‚ùå ANTES
const token = localStorage.getItem('adminToken')
const response = await fetch('/api/endpoint', {
  headers: { 'Authorization': `Bearer ${token}` }
})
const data = await response.json()

// ‚úÖ DESPU√âS  
const response = await apiClient.get('/endpoint')
const data = response.data
```

**Regla 8.5: Migraci√≥n de POST con FormData.**
```javascript
// ‚ùå ANTES
const formData = new FormData()
const response = await fetch('/api/upload', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
})

// ‚úÖ DESPU√âS
const response = await apiClient.post('/upload', formData, {
  headers: { 'Content-Type': 'multipart/form-data' }
})
```

**Regla 8.6: Migraci√≥n de Manejo de Errores.**
```javascript
// ‚ùå ANTES
if (response.ok) {
  // √©xito
} else {
  const error = await response.json()
  console.error(error.message)
}

// ‚úÖ DESPU√âS
try {
  const response = await apiClient.post('/endpoint', data)
  // √©xito autom√°tico
} catch (error) {
  console.error(error.response?.data?.error || 'Error fallback')
}
```

### Casos Especiales
**Regla 8.7: Blob Downloads.** Para descargas de archivos, usar `responseType: 'blob'` en apiClient.

**Regla 8.8: Fallback de localStorage.** En componentes de configuraci√≥n, usar datos de localStorage como fallback si la API falla.

**Regla 8.9: Endpoints Correctos.** Super Admin usa `/super-admin/auth/me`, no `/profile`. Verificar rutas en backend antes de migrar.

## 9. ‚≠ê DOCUMENTACI√ìN SWAGGER API (Junio 23 2025 - Actualizada)

### Documentaci√≥n Completa de APIs
**Regla 9.1: Swagger es la Fuente de Verdad.** Toda API debe estar documentada en Swagger con ejemplos funcionales. Acceso: `http://localhost:3001/api/docs`

**Regla 9.2: Esquemas Consistentes.** Usar esquemas reutilizables para entidades principales (User, Restaurant, Category, Product, Order, etc.)

**Regla 9.3: Ejemplos Reales.** Los ejemplos deben usar datos reales del proyecto (credenciales de Bella Vista, IDs v√°lidos)

**Regla 9.4: Seguridad Documentada.** Cada endpoint protegido debe especificar el esquema de seguridad correcto:
- `bearerAuth`: Administradores de restaurante
- `staffAuth`: Personal/meseros  
- `superAdminAuth`: Super administradores

### APIs Documentadas Completamente
**Regla 9.5: Cobertura Total.** 56+ endpoints documentados organizados en 16 tags:
- Autenticaci√≥n (13 endpoints): Admin, Super Admin, Staff
- Gesti√≥n de Personal (6 endpoints): CRUD completo de meseros
- Gesti√≥n de Men√∫ (10 endpoints): Categor√≠as y productos
- Gesti√≥n de √ìrdenes (10 endpoints): Estados, asignaci√≥n, estad√≠sticas
- Gesti√≥n de Mesas (6 endpoints): CRUD y generaci√≥n de QR
- Gesti√≥n de Restaurantes (5 endpoints): Configuraci√≥n y archivos
- APIs P√∫blicas (3+ endpoints): Men√∫ p√∫blico y seguimiento
- Carrito de Compras (4+ endpoints): Flujo completo de compra

**Regla 9.6: Validaci√≥n Continua.** Todos los endpoints documentados deben estar probados y funcionando antes de commit

**Regla 9.7: Mantenimiento de Documentaci√≥n.** Cualquier cambio en APIs debe actualizarse inmediatamente en Swagger

### üîß **Correcciones Recientes en Documentaci√≥n (v1.0.1)**
**Regla 9.8: Changelog en Swagger.** Mantener historial de cambios en la documentaci√≥n Swagger para tracking de mejoras:
- ‚úÖ **v1.0.1**: Correcci√≥n de include statements en endpoints de suscripciones
- ‚úÖ **v1.0.1**: Mejora en b√∫squeda de planes por precio din√°mico
- ‚úÖ **v1.0.1**: Documentaci√≥n de invalidaci√≥n de tokens tras cambios administrativos
- ‚úÖ **v1.0.1**: Validaci√≥n mejorada de relaciones Prisma en Super Admin endpoints

**Regla 9.9: Endpoints Cr√≠ticos Validados.** Los siguientes endpoints han sido corregidos y validados:
- `GET /api/super-admin/subscriptions/:id` - Include statements completos para relaciones
- `POST /api/auth/register` - B√∫squeda din√°mica de plan gratuito por precio
- Todos los endpoints de Super Admin - Manejo correcto de invalidaci√≥n de tokens

---

## üéØ RESUMEN EJECUTIVO DEL PROYECTO (Estado Final)

### Funcionalidades Clave Implementadas
1. **ü§ñ Generador de Men√∫s con IA**: Procesamiento de im√°genes con GPT-4 Vision para crear men√∫s autom√°ticamente
2. **üé® Drag & Drop Avanzado**: Reordenamiento visual de categor√≠as con @dnd-kit
3. **üì± UX M√≥vil Optimizada**: Pesta√±as horizontales deslizables para mejor experiencia m√≥vil
4. **üîß Arquitectura API Consolidada**: Cliente unificado con interceptores autom√°ticos
5. **üìö Documentaci√≥n Swagger Completa**: 56+ endpoints documentados con ejemplos reales
6. **üí∞ Sistema Multi-Moneda**: Soporte para 7 monedas centroamericanas
7. **üë• Gesti√≥n Multi-Rol**: Super Admin, Admin y Staff con permisos espec√≠ficos
8. **üîÑ Sistema de Suscripciones**: Planes din√°micos con renovaci√≥n autom√°tica

### Arquitectura T√©cnica S√≥lida
- **Backend**: Node.js + Express + Prisma ORM + PostgreSQL
- **Frontend**: React + Vite + Tailwind CSS + @dnd-kit
- **Autenticaci√≥n**: JWT con TOKEN_MAPPING centralizado
- **Documentaci√≥n**: Swagger con versionado y changelog
- **Despliegue**: Docker + Google Cloud Run (automatizado)

### Patrones de Desarrollo Establecidos
- **Regla de Oro**: Un solo cliente API (`apiClient.js`) para toda comunicaci√≥n
- **Servicios por Dominio**: Cada √°rea funcional tiene su servicio dedicado
- **Componentes Reutilizables**: Drag & Drop, formularios, modales estandarizados
- **Validaci√≥n Dual**: Frontend (UX) + Backend (seguridad) en todos los endpoints
- **Documentaci√≥n Viva**: Swagger actualizado con cada cambio de API

### Estado de Producci√≥n
- ‚úÖ **MVP Completo**: Todas las funcionalidades principales implementadas
- ‚úÖ **Bugs Cr√≠ticos Resueltos**: Include statements, b√∫squeda de planes, tokens
- ‚úÖ **UX Optimizada**: Interfaz m√≥vil mejorada con patrones modernos
- ‚úÖ **Documentaci√≥n Completa**: Swagger, PROJECT-STATUS.md, reglas actualizadas
- ‚úÖ **Arquitectura Escalable**: Patrones establecidos para futuras funcionalidades

**El proyecto est√° listo para producci√≥n con solo configurar `OPENAI_API_KEY` en Cloud Run.**