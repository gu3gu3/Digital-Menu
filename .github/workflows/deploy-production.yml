name: ðŸš€ Deploy to Production (menuview.app)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  GCP_PROJECT_ID: digital-menu-455517
  GCP_REGION: us-central1
  BACKEND_SERVICE_NAME: menuview-api
  FRONTEND_SERVICE_NAME: menuview-frontend

jobs:
  # ===============================
  # JOB 1: BUILD & TEST
  # ===============================
  build-test:
    name: ðŸ§ª Build & Test
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.generate_info.outputs.sha }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ“ Generate Prisma Client
      run: npm exec --workspace=backend -- prisma generate

    - name: ðŸ§ª Run backend tests
      run: npm run test --workspace=backend
      continue-on-error: true

    - name: ðŸ—ï¸ Build frontend
      run: npm run build --workspace=frontend
      env:
        VITE_API_URL: https://api.menuview.app/api

    - name: ðŸ“‹ Generate build info
      id: generate_info
      run: echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

  # ===============================
  # JOB 2: DEPLOY BACKEND API
  # ===============================
  deploy-backend:
    name: ðŸ”§ Deploy Backend API
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: ðŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸ³ Configure Docker for GCP
      run: gcloud auth configure-docker

    - name: ðŸ”§ Deploy to Cloud Run (Backend)
      run: |
        cd packages/backend
        gcloud run deploy ${{ env.BACKEND_SERVICE_NAME }} \
          --source . \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --service-account menuview-run@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
          --add-cloudsql-instances ${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:menuview-db \
          --set-env-vars NODE_ENV=production,FRONTEND_URL=https://menuview.app \
          --set-secrets DATABASE_URL=database-url:latest,JWT_SECRET=jwt-secret:latest,SUPER_USER_EMAIL=super-user-email:latest,SUPER_USER_PASSWORD=super-user-password:latest,GCP_PROJECT_ID=gcp-project-id:latest,GCP_STORAGE_BUCKET=gcp-storage-bucket:latest \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 1 \
          --max-instances 10 \
          --timeout 300s \
          --tag build-${{ needs.build-test.outputs.sha }} \
          --quiet

    - name: ðŸ“ Get Backend URL
      run: |
        BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE_NAME }} --region=${{ env.GCP_REGION }} --format="value(status.url)")
        echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV

  # ===============================
  # JOB 3: RUN DATABASE MIGRATIONS
  # ===============================
  migrate-database:
    name: ðŸ—„ï¸ Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: ðŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸ—„ï¸ Run Database Migrations
      run: |
        cd packages/backend
        
        # Crear job temporal para migraciones
        gcloud run jobs create menuview-migrate-$(date +%s) \
          --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }} \
          --region ${{ env.GCP_REGION }} \
          --service-account menuview-run@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
          --set-cloudsql-instances ${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:menuview-db \
          --set-secrets DATABASE_URL=database-url:latest \
          --command npx \
          --args prisma,migrate,deploy \
          --max-retries 3 \
          --parallelism 1
        
        # Ejecutar migraciones
        JOB_NAME=$(gcloud run jobs list --filter="metadata.name:menuview-migrate" --format="value(metadata.name)" --limit=1)
        gcloud run jobs execute $JOB_NAME --region=${{ env.GCP_REGION }} --wait

  # ===============================
  # JOB 4: DEPLOY FRONTEND 
  # ===============================
  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [deploy-backend, migrate-database]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: ðŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸ—ï¸ Build Frontend for Production
      run: |
        cd packages/frontend
        npm ci
        npm run build
      env:
        VITE_API_URL: https://api.menuview.app/api

    - name: ðŸš€ Deploy to Cloud Run (Frontend)
      run: |
        cd packages/frontend
        
        # Crear Dockerfile temporal para frontend
        cat > Dockerfile << EOF
        FROM nginx:alpine
        COPY dist /usr/share/nginx/html
        COPY nginx.conf /etc/nginx/conf.d/default.conf
        EXPOSE 8080
        CMD ["nginx", "-g", "daemon off;"]
        EOF
        
        # Crear configuraciÃ³n nginx
        cat > nginx.conf << EOF
        server {
            listen 8080;
            location / {
                root /usr/share/nginx/html;
                index index.html index.htm;
                try_files \$uri \$uri/ /index.html;
            }
        }
        EOF
        
        gcloud run deploy ${{ env.FRONTEND_SERVICE_NAME }} \
          --source . \
          --platform managed \
          --region ${{ env.GCP_REGION }} \
          --allow-unauthenticated \
          --memory 256Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --port 8080 \
          --tag build-${{ needs.build-test.outputs.sha }} \
          --quiet

  # ===============================
  # JOB 5: CONFIGURE DOMAIN MAPPING
  # ===============================
  configure-domains:
    name: ðŸŒ Configure Domain Mapping
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: ðŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸŒ Configure Domain Mappings
      run: |
        # Frontend domains
        gcloud run domain-mappings create \
          --service ${{ env.FRONTEND_SERVICE_NAME }} \
          --domain menuview.app \
          --region ${{ env.GCP_REGION }} || true

        gcloud run domain-mappings create \
          --service ${{ env.FRONTEND_SERVICE_NAME }} \
          --domain www.menuview.app \
          --region ${{ env.GCP_REGION }} || true

        # Backend API domain
        gcloud run domain-mappings create \
          --service ${{ env.BACKEND_SERVICE_NAME }} \
          --domain api.menuview.app \
          --region ${{ env.GCP_REGION }} || true

  # ===============================
  # JOB 6: HEALTH CHECK & NOTIFICATION
  # ===============================
  health-check:
    name: ðŸ¥ Health Check & Notify
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, configure-domains]
    if: always()
    
    steps:
    - name: ðŸ§ª Test Backend Health
      run: |
        sleep 30 # Wait for services to be ready
        curl -f https://api.menuview.app/health || exit 1

    - name: ðŸ§ª Test Frontend
      run: |
        curl -f https://menuview.app || exit 1

    - name: âœ… Deployment Success Notification
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment to menuview.app completed successfully!"
        echo "- Backend API: https://api.menuview.app"
        echo "- Frontend: https://menuview.app"
        echo "- Build SHA: ${{ needs.build-test.outputs.sha }}"

    - name: âŒ Deployment Failed Notification
      if: failure()
      run: |
        echo "ðŸ’¥ Deployment to menuview.app FAILED!"
        echo "Please check the logs and fix the issues." 